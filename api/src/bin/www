#!/usr/bin/env node
'use strict';

var { debug, passport } = require('../config/dependencies');
var { UserService } = require('../services');

// Initialize passport.
passport.use(new passport.facebookStrategy({
  clientID: process.env.FACEBOOK_CLIENT_ID, 
  clientSecret: process.env.FACEBOOK_CLIENT_SECRET
}, async(accessToken, refreshToken, profile, done) => {
  try {
    var user = await UserService.getByFacebookId(profile.id);
    if (!user) {
      user = {
        facebookId: profile.id,
        facebookToken: accessToken,
        email: profile.emails[0].value,
      };
    }
    done(null, user);
  } catch (err) {
    done(err);
  }  
}));

var app = require('../app');
var port = process.env.PORT || '3000';

app.listen(port, () => {
  debug('Listening on port: ' + port);
});